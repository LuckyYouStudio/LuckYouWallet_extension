<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckYou Wallet 检测测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .debug-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 LuckYou Wallet 检测测试</h1>
        
        <div id="status">
            <div class="status info">正在检测钱包扩展...</div>
        </div>
        
        <div class="debug-info">
            <strong>页面信息:</strong><br>
            URL: <span id="pageUrl"></span><br>
            协议: <span id="pageProtocol"></span><br>
            主机: <span id="pageHost"></span>
        </div>
        
        <div class="debug-info">
            <strong>钱包状态:</strong><br>
            window.ethereum: <span id="ethereumStatus">检查中...</span><br>
            window.luckyouWallet: <span id="luckyouWalletStatus">检查中...</span><br>
            window.web3: <span id="web3Status">检查中...</span>
        </div>
        
        <button onclick="checkExtension()">重新检查扩展</button>
        <button onclick="clearLog()">清除日志</button>
        <button onclick="testConnection()">测试连接</button>
        
        <h3>详细日志:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logs = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            updateLog();
            console.log(logEntry);
        }
        
        function updateLog() {
            const logDiv = document.getElementById('log');
            logDiv.textContent = logs.join('\n');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logs = [];
            updateLog();
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateDebugInfo() {
            document.getElementById('pageUrl').textContent = window.location.href;
            document.getElementById('pageProtocol').textContent = window.location.protocol;
            document.getElementById('pageHost').textContent = window.location.host;
            
            // 更新钱包状态
            const ethereumStatus = window.ethereum ? 
                `存在: ${window.ethereum.isMetaMask ? 'MetaMask' : (window.ethereum.isLuckYouWallet ? 'LuckYou Wallet' : '其他')}` : 
                '不存在';
            document.getElementById('ethereumStatus').textContent = ethereumStatus;
            
            const luckyouWalletStatus = window.luckyouWallet ? 
                `存在: ${window.luckyouWallet.isLuckYouWallet ? 'LuckYou Wallet' : '其他'}` : 
                '不存在';
            document.getElementById('luckyouWalletStatus').textContent = luckyouWalletStatus;
            
            const web3Status = window.web3 ? '存在' : '不存在';
            document.getElementById('web3Status').textContent = web3Status;
        }
        
        function checkExtension() {
            log('开始检查扩展状态...');
            updateDebugInfo();
            
            let luckYouFound = false;
            let detectionMethod = '';
            
            // 检查 window.ethereum
            if (window.ethereum) {
                log('✅ window.ethereum 存在');
                log(`   类型: ${typeof window.ethereum}`);
                log(`   isMetaMask: ${window.ethereum.isMetaMask}`);
                log(`   isLuckYouWallet: ${window.ethereum.isLuckYouWallet}`);
                
                if (window.ethereum.isLuckYouWallet) {
                    luckYouFound = true;
                    detectionMethod = 'window.ethereum';
                    updateStatus('🎉 检测到 LuckYou Wallet (通过 window.ethereum)', 'success');
                    log('🎉 检测到 LuckYou Wallet (通过 window.ethereum)');
                } else if (window.ethereum.isMetaMask) {
                    log('🦊 检测到 MetaMask');
                } else {
                    log('❓ 未知的 ethereum provider');
                }
            } else {
                log('❌ window.ethereum 不存在');
            }
            
            // 检查 window.luckyouWallet
            if (window.luckyouWallet) {
                log('✅ window.luckyouWallet 存在');
                log(`   类型: ${typeof window.luckyouWallet}`);
                log(`   isLuckYouWallet: ${window.luckyouWallet.isLuckYouWallet}`);
                
                if (window.luckyouWallet.isLuckYouWallet) {
                    luckYouFound = true;
                    detectionMethod = 'window.luckyouWallet';
                    updateStatus('🎉 检测到 LuckYou Wallet (通过 window.luckyouWallet)', 'success');
                    log('🎉 检测到 LuckYou Wallet (通过 window.luckyouWallet)');
                } else {
                    log('⚠️ window.luckyouWallet 存在但不是 LuckYou Wallet');
                }
            } else {
                log('ℹ️ window.luckyouWallet 不存在');
            }
            
            // 检查 window.web3
            if (window.web3) {
                log('✅ window.web3 存在');
                log(`   类型: ${typeof window.web3}`);
            } else {
                log('ℹ️ window.web3 不存在');
            }
            
            if (!luckYouFound) {
                updateStatus('❌ 未检测到 LuckYou Wallet 扩展', 'error');
                log('❌ 未检测到 LuckYou Wallet 扩展');
                log('请确保：');
                log('1. 已安装 LuckYou Wallet 扩展');
                log('2. 扩展已启用');
                log('3. 页面已重新加载');
            } else {
                log(`✅ LuckYou Wallet 检测成功！检测方式: ${detectionMethod}`);
            }
        }
        
        async function testConnection() {
            log('开始测试钱包连接...');
            
            try {
                let provider = null;
                
                // 优先使用 luckyouWallet
                if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                    provider = window.luckyouWallet;
                    log('使用 window.luckyouWallet 进行测试');
                } else if (window.ethereum && window.ethereum.isLuckYouWallet) {
                    provider = window.ethereum;
                    log('使用 window.ethereum 进行测试');
                } else {
                    log('❌ 没有找到 LuckYou Wallet provider');
                    return;
                }
                
                // 测试基本方法
                log('测试 requestAccounts...');
                const accounts = await provider.requestAccounts();
                log(`✅ 获取到账户: ${accounts.length} 个`);
                
                if (accounts.length > 0) {
                    log(`第一个账户: ${accounts[0]}`);
                }
                
                log('测试 getChainId...');
                const chainId = await provider.getChainId();
                log(`✅ 链ID: ${chainId}`);
                
                updateStatus('🎉 钱包连接测试成功！', 'success');
                
            } catch (error) {
                log(`❌ 连接测试失败: ${error.message}`);
                updateStatus('❌ 钱包连接测试失败', 'error');
            }
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('页面加载完成');
            updateDebugInfo();
            setTimeout(() => {
                log('延迟检查扩展...');
                checkExtension();
            }, 1000);
        });
        
        // 监听 ethereum#initialized 事件
        window.addEventListener('ethereum#initialized', () => {
            log('🎉 检测到 ethereum#initialized 事件');
            setTimeout(() => {
                log('事件触发后检查扩展...');
                checkExtension();
            }, 500);
        });
        
        // 定期检查
        let checkInterval = setInterval(() => {
            if (window.luckyouWallet || (window.ethereum && window.ethereum.isLuckYouWallet)) {
                log('✅ 检测到 LuckYou Wallet，停止定期检查');
                clearInterval(checkInterval);
                checkExtension();
            }
        }, 1000);
        
        // 10秒后停止检查
        setTimeout(() => {
            clearInterval(checkInterval);
            log('⏰ 定期检查超时');
        }, 10000);
    </script>
</body>
</html>
