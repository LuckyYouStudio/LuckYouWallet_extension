<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckYou Wallet æ‰©å±•è¯Šæ–­</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #212529;
            text-align: center;
            margin-bottom: 30px;
        }
        .diagnostic-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .diagnostic-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .info-box {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .wallet-selector {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #dee2e6;
        }
        .wallet-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .wallet-option:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        .wallet-option.selected {
            border-color: #28a745;
            background-color: #f0fff0;
        }
        .wallet-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }
        .wallet-info {
            flex: 1;
        }
        .wallet-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .wallet-description {
            color: #666;
            font-size: 14px;
        }
        .wallet-status {
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-available {
            background-color: #d4edda;
            color: #155724;
        }
        .status-unavailable {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LuckYou Wallet æ‰©å±•è¯Šæ–­å·¥å…·</h1>
        
        <div class="info-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
            <ol>
                <li>ç¡®ä¿å·²å®‰è£… LuckYou Wallet æµè§ˆå™¨æ‰©å±•</li>
                <li>åœ¨æ‰©å±•ç®¡ç†é¡µé¢ä¸­å¯ç”¨æ‰©å±•</li>
                <li>é€‰æ‹©è¦ä½¿ç”¨çš„é’±åŒ…</li>
                <li>ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®</li>
                <li>æŸ¥çœ‹è¯Šæ–­ç»“æœå’Œæ—¥å¿—ä¿¡æ¯</li>
            </ol>
        </div>
        
        <!-- é’±åŒ…é€‰æ‹©å™¨ -->
        <div class="wallet-selector">
            <h3>ğŸ” é€‰æ‹©é’±åŒ…</h3>
            <div id="walletOptions"></div>
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="startDiagnostic()">ğŸ” å¼€å§‹è¯Šæ–­</button>
            <button class="btn-success" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
            <button class="btn-warning" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
            <button class="btn-danger" onclick="resetDiagnostic()">ğŸ”„ é‡ç½®è¯Šæ–­</button>
        </div>
        
        <div id="diagnosticResults"></div>
        
        <div id="logs" class="log-box" style="display: none;"></div>
    </div>

    <script>
        let diagnosticResults = {};
        let logs = [];
        let availableWallets = [];
        let selectedWallet = null;
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            updateLogDisplay();
            console.log(logEntry);
        }
        
        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function updateLogDisplay() {
            const logsEl = document.getElementById('logs');
            logsEl.style.display = 'block';
            logsEl.textContent = logs.join('\n');
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        // æ£€æµ‹å¯ç”¨çš„é’±åŒ…
        function detectAvailableWallets() {
            availableWallets = [];
            
            // æ£€æµ‹ MetaMask
            if (window.ethereum && window.ethereum.isMetaMask) {
                availableWallets.push({
                    id: 'metamask',
                    name: 'MetaMask',
                    icon: 'ğŸ¦Š',
                    description: 'MetaMask é’±åŒ…æ‰©å±•',
                    provider: window.ethereum,
                    isAvailable: true
                });
            }
            
            // æ£€æµ‹ LuckYou Wallet
            if (window.ethereum && window.ethereum.isLuckYouWallet) {
                availableWallets.push({
                    id: 'luckyou',
                    name: 'LuckYou Wallet',
                    icon: 'ğŸ€',
                    description: 'LuckYou Wallet æ‰©å±• (é€šè¿‡ ethereum)',
                    provider: window.ethereum,
                    isAvailable: true
                });
            }
            
            // æ£€æµ‹ LuckYou Wallet (æ›¿ä»£å¯¹è±¡)
            if (window.luckyouWallet && window.luckyouWallet.isLuckYouWallet) {
                availableWallets.push({
                    id: 'luckyou-alt',
                    name: 'LuckYou Wallet',
                    icon: 'ğŸ€',
                    description: 'LuckYou Wallet æ‰©å±• (æ›¿ä»£å¯¹è±¡)',
                    provider: window.luckyouWallet,
                    isAvailable: true
                });
            }
            
            // æ£€æµ‹å…¶ä»–å¯èƒ½çš„é’±åŒ…
            if (window.web3) {
                availableWallets.push({
                    id: 'web3',
                    name: 'Web3 Provider',
                    icon: 'ğŸŒ',
                    description: 'é€šç”¨ Web3 æä¾›è€…',
                    provider: window.web3,
                    isAvailable: true
                });
            }
            
            // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•é’±åŒ…
            if (availableWallets.length === 0) {
                availableWallets.push({
                    id: 'none',
                    name: 'æ— å¯ç”¨é’±åŒ…',
                    icon: 'âŒ',
                    description: 'è¯·å®‰è£…å¹¶å¯ç”¨é’±åŒ…æ‰©å±•',
                    provider: null,
                    isAvailable: false
                });
            }
            
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„é’±åŒ…
            if (availableWallets.length > 0 && availableWallets[0].isAvailable) {
                selectedWallet = availableWallets[0];
            }
            
            addLog(`æ£€æµ‹åˆ° ${availableWallets.length} ä¸ªé’±åŒ…`);
            renderWalletOptions();
        }
        
        // æ¸²æŸ“é’±åŒ…é€‰æ‹©å™¨
        function renderWalletOptions() {
            const container = document.getElementById('walletOptions');
            let html = '';
            
            availableWallets.forEach(wallet => {
                const isSelected = selectedWallet && selectedWallet.id === wallet.id;
                const statusClass = wallet.isAvailable ? 'status-available' : 'status-unavailable';
                const statusText = wallet.isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨';
                
                html += `
                    <div class="wallet-option ${isSelected ? 'selected' : ''}" 
                         onclick="selectWallet('${wallet.id}')">
                        <div class="wallet-icon">${wallet.icon}</div>
                        <div class="wallet-info">
                            <div class="wallet-name">${wallet.name}</div>
                            <div class="wallet-description">${wallet.description}</div>
                        </div>
                        <div class="wallet-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // é€‰æ‹©é’±åŒ…
        function selectWallet(walletId) {
            const wallet = availableWallets.find(w => w.id === walletId);
            if (wallet && wallet.isAvailable) {
                selectedWallet = wallet;
                addLog(`é€‰æ‹©é’±åŒ…: ${wallet.name}`);
                renderWalletOptions();
            }
        }
        
        // è·å–å½“å‰é€‰ä¸­çš„é’±åŒ…æä¾›è€…
        function getCurrentProvider() {
            if (!selectedWallet || !selectedWallet.isAvailable) {
                throw new Error('æ²¡æœ‰é€‰æ‹©å¯ç”¨çš„é’±åŒ…');
            }
            return selectedWallet.provider;
        }
        
        // å¼€å§‹è¯Šæ–­
        async function startDiagnostic() {
            addLog('å¼€å§‹æ‰©å±•è¯Šæ–­...');
            diagnosticResults = {};
            
            // è¯Šæ–­1ï¼šæ£€æŸ¥é€‰ä¸­çš„é’±åŒ…
            addLog(`æ£€æŸ¥é€‰ä¸­çš„é’±åŒ…: ${selectedWallet ? selectedWallet.name : 'æ— '}`);
            if (selectedWallet && selectedWallet.isAvailable) {
                diagnosticResults.selectedWallet = {
                    status: 'success',
                    message: `å·²é€‰æ‹©é’±åŒ…: ${selectedWallet.name}`,
                    details: {
                        id: selectedWallet.id,
                        name: selectedWallet.name,
                        description: selectedWallet.description,
                        provider: selectedWallet.provider ? 'å¯ç”¨' : 'ä¸å¯ç”¨'
                    }
                };
                addLog(`âœ… å·²é€‰æ‹©é’±åŒ…: ${selectedWallet.name}`);
            } else {
                diagnosticResults.selectedWallet = {
                    status: 'error',
                    message: 'æ²¡æœ‰é€‰æ‹©å¯ç”¨çš„é’±åŒ…'
                };
                addLog('âŒ æ²¡æœ‰é€‰æ‹©å¯ç”¨çš„é’±åŒ…');
                return;
            }
            
            // è¯Šæ–­2ï¼šæ£€æŸ¥é’±åŒ…æä¾›è€…
            addLog('æ£€æŸ¥é’±åŒ…æä¾›è€…...');
            try {
                const provider = getCurrentProvider();
                diagnosticResults.provider = {
                    status: 'success',
                    message: 'é’±åŒ…æä¾›è€…å¯ç”¨',
                    details: {
                        isMetaMask: provider.isMetaMask,
                        isLuckYouWallet: provider.isLuckYouWallet,
                        isConnected: provider.isConnected ? provider.isConnected() : 'N/A',
                        selectedAddress: provider.selectedAddress,
                        chainId: provider.chainId,
                        networkVersion: provider.networkVersion
                    }
                };
                addLog('âœ… é’±åŒ…æä¾›è€…å¯ç”¨');
            } catch (error) {
                diagnosticResults.provider = {
                    status: 'error',
                    message: 'é’±åŒ…æä¾›è€…ä¸å¯ç”¨',
                    details: error.message
                };
                addLog('âŒ é’±åŒ…æä¾›è€…ä¸å¯ç”¨: ' + error.message);
                return;
            }
            
            // è¯Šæ–­3ï¼šæ£€æŸ¥ç½‘ç»œè¯·æ±‚èƒ½åŠ›
            addLog('æ£€æŸ¥ç½‘ç»œè¯·æ±‚èƒ½åŠ›...');
            try {
                const provider = getCurrentProvider();
                const chainId = await provider.request({ method: 'eth_chainId' });
                diagnosticResults.networkTest = {
                    status: 'success',
                    message: 'ç½‘ç»œè¯·æ±‚æµ‹è¯•æˆåŠŸ',
                    details: { chainId, method: 'eth_chainId' }
                };
                addLog('âœ… ç½‘ç»œè¯·æ±‚æµ‹è¯•æˆåŠŸ');
            } catch (error) {
                diagnosticResults.networkTest = {
                    status: 'error',
                    message: 'ç½‘ç»œè¯·æ±‚æµ‹è¯•å¤±è´¥',
                    details: error.message
                };
                addLog('âŒ ç½‘ç»œè¯·æ±‚æµ‹è¯•å¤±è´¥: ' + error.message);
            }
            
            // è¯Šæ–­4ï¼šæ£€æŸ¥é¡µé¢ç¯å¢ƒ
            addLog('æ£€æŸ¥é¡µé¢ç¯å¢ƒ...');
            diagnosticResults.pageEnvironment = {
                status: 'info',
                message: 'é¡µé¢ç¯å¢ƒä¿¡æ¯',
                details: {
                    url: window.location.href,
                    protocol: window.location.protocol,
                    hostname: window.location.hostname,
                    userAgent: navigator.userAgent,
                    isLocalFile: window.location.protocol === 'file:',
                    isSecure: window.location.protocol === 'https:',
                    selectedWallet: selectedWallet ? selectedWallet.name : 'æ— '
                }
            };
            addLog('â„¹ï¸ é¡µé¢ç¯å¢ƒæ£€æŸ¥å®Œæˆ');
            
            // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            displayDiagnosticResults();
            addLog('è¯Šæ–­å®Œæˆï¼');
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            addLog('å¼€å§‹æµ‹è¯•é’±åŒ…è¿æ¥...');
            
            try {
                if (!selectedWallet || !selectedWallet.isAvailable) {
                    throw new Error('æ²¡æœ‰é€‰æ‹©å¯ç”¨çš„é’±åŒ…');
                }
                
                const provider = getCurrentProvider();
                addLog(`è¯·æ±‚è¿æ¥é’±åŒ…: ${selectedWallet.name}`);
                
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                
                addLog('è¿æ¥æˆåŠŸï¼è´¦æˆ·: ' + accounts.join(', '));
                diagnosticResults.connectionTest = {
                    status: 'success',
                    message: 'é’±åŒ…è¿æ¥æµ‹è¯•æˆåŠŸ',
                    details: { 
                        wallet: selectedWallet.name,
                        accounts: accounts 
                    }
                };
                
            } catch (error) {
                addLog('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                diagnosticResults.connectionTest = {
                    status: 'error',
                    message: 'é’±åŒ…è¿æ¥æµ‹è¯•å¤±è´¥',
                    details: error.message
                };
            }
            
            displayDiagnosticResults();
        }
        
        // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
        function displayDiagnosticResults() {
            const resultsEl = document.getElementById('diagnosticResults');
            let html = '<h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>';
            
            for (const [key, result] of Object.entries(diagnosticResults)) {
                const statusClass = result.status || 'info';
                const statusIcon = {
                    'success': 'âœ…',
                    'error': 'âŒ',
                    'warning': 'âš ï¸',
                    'info': 'â„¹ï¸'
                }[statusClass] || 'â„¹ï¸';
                
                html += `
                    <div class="diagnostic-section">
                        <h3>${statusIcon} ${key.charAt(0).toUpperCase() + key.slice(1)}</h3>
                        <div class="status ${statusClass}">
                            ${result.message}
                        </div>
                        ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                    </div>
                `;
            }
            
            resultsEl.innerHTML = html;
        }
        
        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            logs = [];
            updateLogDisplay();
            addLog('æ—¥å¿—å·²æ¸…é™¤');
        }
        
        // é‡ç½®è¯Šæ–­
        function resetDiagnostic() {
            diagnosticResults = {};
            logs = [];
            document.getElementById('diagnosticResults').innerHTML = '';
            document.getElementById('logs').style.display = 'none';
            addLog('è¯Šæ–­å·²é‡ç½®');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹é’±åŒ…
        window.addEventListener('load', () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æµ‹é’±åŒ…...');
            addLog('å½“å‰é¡µé¢URL: ' + window.location.href);
            addLog('å½“å‰åè®®: ' + window.location.protocol);
            
            // å»¶è¿Ÿæ£€æµ‹ï¼Œç¡®ä¿æ‰©å±•æœ‰è¶³å¤Ÿæ—¶é—´æ³¨å…¥
            setTimeout(() => {
                detectAvailableWallets();
            }, 1000);
        });
        
        // ç›‘å¬ethereum#initializedäº‹ä»¶
        window.addEventListener('ethereum#initialized', () => {
            addLog('æ£€æµ‹åˆ° ethereum#initialized äº‹ä»¶');
            detectAvailableWallets();
        });
        
        // ç›‘å¬ethereumå¯¹è±¡å˜åŒ–
        let ethereumCheckInterval = setInterval(() => {
            if (window.ethereum && availableWallets.length === 0) {
                addLog('æ£€æµ‹åˆ° ethereum å¯¹è±¡åŠ¨æ€æ³¨å…¥');
                clearInterval(ethereumCheckInterval);
                detectAvailableWallets();
            }
        }, 1000);
        
        // 10ç§’ååœæ­¢æ£€æŸ¥
        setTimeout(() => {
            clearInterval(ethereumCheckInterval);
            if (availableWallets.length === 0) {
                addLog('ethereum å¯¹è±¡æ£€æŸ¥è¶…æ—¶ï¼Œå°è¯•é‡æ–°æ£€æµ‹');
                detectAvailableWallets();
            }
        }, 10000);
    </script>
</body>
</html>
